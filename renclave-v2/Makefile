# Makefile for renclave-v2

.PHONY: help build test clean docker-build docker-test docker-clean run-host run-enclave

# Default target
help:
	@echo "renclave-v2 - QEMU Nitro Enclave Seed Generation"
	@echo ""
	@echo "Available targets:"
	@echo "  build         - Build all Rust binaries"
	@echo "  test          - Run Rust tests"
	@echo "  clean         - Clean build artifacts"
	@echo "  docker-build  - Build Docker image"
	@echo "  docker-test   - Run tests in Docker"
	@echo "  docker-clean  - Clean Docker images and containers"
	@echo "  run-host      - Run host binary"
	@echo "  run-enclave   - Run enclave binary"
	@echo "  run-both      - Run both host and enclave"

# Rust build targets
build:
	@echo "ðŸ”¨ Building renclave-v2..."
	cargo build --release --workspace

test:
	@echo "ðŸ§ª Running Rust tests..."
	cargo test --workspace

clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	cargo clean

# Docker targets
docker-build:
	@echo "ðŸ³ Building Docker image..."
	docker-compose -f docker/docker-compose.yml build

docker-test:
	@echo "ðŸ³ Running tests in Docker..."
	docker-compose -f docker/docker-compose.yml up --abort-on-container-exit

docker-test-host-only:
	@echo "ðŸ³ Running host-only tests in Docker..."
	docker-compose -f docker/docker-compose.yml --profile host-only up --abort-on-container-exit

docker-test-network:
	@echo "ðŸ³ Running network tests in Docker..."
	docker-compose -f docker/docker-compose.yml --profile network-test up --abort-on-container-exit

docker-clean:
	@echo "ðŸ³ Cleaning Docker resources..."
	docker-compose -f docker/docker-compose.yml down --volumes --remove-orphans
	docker system prune -f

# Local execution targets
run-enclave: build
	@echo "ðŸ”’ Starting enclave..."
	./target/release/enclave

run-host: build
	@echo "ðŸ  Starting host..."
	./target/release/host

run-both: build
	@echo "ðŸš€ Starting both enclave and host..."
	@echo "Starting enclave in background..."
	./target/release/enclave &
	@sleep 3
	@echo "Starting host..."
	./target/release/host

# Development targets
dev-build:
	@echo "ðŸ”¨ Building in development mode..."
	cargo build --workspace

dev-test:
	@echo "ðŸ§ª Running tests in development mode..."
	cargo test --workspace -- --nocapture

dev-watch:
	@echo "ðŸ‘€ Watching for changes..."
	cargo watch -x "build --workspace"

# Linting and formatting
fmt:
	@echo "ðŸŽ¨ Formatting code..."
	cargo fmt --all

clippy:
	@echo "ðŸ“Ž Running clippy..."
	cargo clippy --workspace --all-targets --all-features

# Documentation
docs:
	@echo "ðŸ“š Building documentation..."
	cargo doc --workspace --no-deps

docs-open:
	@echo "ðŸ“š Opening documentation..."
	cargo doc --workspace --no-deps --open

# Benchmarks (if any)
bench:
	@echo "âš¡ Running benchmarks..."
	cargo bench --workspace

# Security audit
audit:
	@echo "ðŸ”’ Running security audit..."
	cargo audit

# Check all
check-all: fmt clippy test audit
	@echo "âœ… All checks completed"

# Install dependencies
install-deps:
	@echo "ðŸ“¦ Installing dependencies..."
	cargo install cargo-watch cargo-audit

# Quick start
quick-start: docker-build docker-test
	@echo "ðŸŽ‰ Quick start completed!"

# Production build
prod-build:
	@echo "ðŸ­ Building for production..."
	cargo build --release --workspace
	strip target/release/enclave target/release/host

# Create release
release: clean prod-build test
	@echo "ðŸ“¦ Creating release..."
	mkdir -p release
	cp target/release/enclave release/
	cp target/release/host release/
	cp -r docker release/
	cp README.md release/ 2>/dev/null || true
	tar -czf renclave-v2-release.tar.gz release/
	@echo "âœ… Release created: renclave-v2-release.tar.gz"
